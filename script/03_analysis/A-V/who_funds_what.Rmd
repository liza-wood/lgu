---
title: "Who funds what?"
subtitle: "Research funding for LGU Agricultural Colleges, 2000-2020"
author: "Victoria C. Fletcher"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
##### SET THIS TO YOUR OWN PATH! #####
path_to_box <- '~/Library/CloudStorage/Box-Box/lgu'
```

```{r setup, include = F}
library(tidyverse)
knitr::opts_chunk$set(echo = T, warning = F, message = F, results = T)
knitr::opts_knit$set(root.dir = path_to_box)
```

```{r, echo = F}
setwd(path_to_box)
all_awards <- unique(read.csv('data_clean/awards_selected_states.csv'))
breeder_awards <- read.csv('data_clean/funds_df.csv')
inventors <- read.csv('data_clean/inventor_index.csv')
```

```{r, echo = F}
# Here I am adding a piece of information to the all_awards data frame, which is giving a logical value for whether or not the PI who received the award is on our list of breeders
all_awards <- breeder_awards %>% 
  select(-funding) %>% 
  mutate(breeder = T) %>% 
  right_join(all_awards) %>% 
  mutate(breeder = ifelse(is.na(breeder), F, T))
```

# Awards Data

## Awards data frame column names and descriptions:

-   uni_state: "University State"
-   inventor_last: "Inventor Last Name"
-   inventor_first_1: "Inventor Initial of First Name"
-   breeder: "Inventor Matches With Inventor in License Data"
-   Sponsor: "Award Sponsor"
-   AwardAmt: "Amount of Award \$"
-   StartDate: "Start of Award Period"
-   EndDate: "End of Award Period"
-   ProjectTitle: "Title of Project"
-   PIFullName: "Full Name of Principle Investigator"
-   Dept: "Department"
-   inventor_first: "Inventor First Name"
-   start_year: "Project Starting Year"
-   end_year: "Project Ending Year"
-   amt: "Amount of Award"

```{r}
colnames(all_awards)
```

## Renaming Column Names for Clarity:

-   inventor_last --\> "inventor_lastname"
-   inventor_first_1 --\> "inventor_first"
-   breeder --\> "inventorlist_check"
-   inventor_first --\> "inventor_firstname"

```{r}
colnames(all_awards)[2] = "inventor_lastname"
colnames(all_awards)[3] = "inventor_first"
colnames(all_awards)[4] = "inventorlist_check"
colnames(all_awards)[12] = "inventor_firstname"
```

## Removing Irrelevant Columns

At this point in time, some of the columns are irrelevant and thus may cause confusion when analyzing the data. Therefore, I will go ahead and remove some of these columns with the select function:

-   AwardAmt: This data is difficult to work with because of how it is formatted, with dollar signs accompanying the numbers. Trying to summarize this data will be unfruitful and will cause the program to produce errors. Therefore I have decided to keep the "awd" column for now as it avoids this problematic formatting.

-   StartDate & EndDate: These are both not necessary pieces of the data as we have the start and end years; right now we do not need anything more specific than the start and end year, thus we will remove the StardDate and EndDate for now.

-   Awards data \< 0: We will also go ahead and remove the awards data less that appear to be less than zero. This is largely because we do not have a clear understanding as to what these values mean in our data.

```{r}
# Use select to reduce the number of columns
all_awards_revised <- all_awards %>% 
  select(uni_state,inventor_lastname,inventor_first,inventorlist_check,Sponsor,amt,ProjectTitle,PIFullName,Dept,start_year,inventor_firstname,end_year)

grp_cols <- colnames(all_awards_revised)[-6]
# Liza's addition -- we want to know the sum total for the project
# This sums up the funding per year and subtracts the money that was negative,
# which I learned from the group means that it was actually reduced
all_awards_revised <- all_awards_revised %>% 
  group_by(uni_state, inventor_lastname, inventor_first,
           inventorlist_check, #Sponsor, removign sponsor because sometimes (Sandoval)
                                # has same sponsor 
           ProjectTitle,
           PIFullName, end_year, #Dept, exlcuding dept and endyear because some have dual appointments
           start_year, inventor_firstname) %>% 
  filter(ProjectTitle != "Feed the Future Innovation Lab for Collaborative Research on Horticulture (Horticulture Innovation Lab)") %>% 
  summarize(amt = sum(amt,na.rm = T)) %>% 
  # then removing negative which would mean something weird but need to spend time with it
  filter(amt >=0)

```

```{r, echo = F}
colnames(all_awards_revised)
```

## Awards Data Summaries

Across all of the grants in our awards data, what is the average amount of funding a project receives

-   Using the summary function and looking into the "awd" data column we can find the average amount of funding a projected received.

```{r}
summary(all_awards_revised$amt)
summary(all_awards_revised2$amt)
```

Does this amount vary across universities? How much money has each university gotten each year?

-   Average Amount per University (all time)

    -   Method: group by uni_state, and then summarize by mean and remove NA values

```{r}
all_awards_revised %>% 
    group_by(uni_state) %>% 
  summarize(mean_awardamt = mean(amt, na.rm= TRUE))
```

-   Average Amount per University per Year
    -   Method: group by uni_state and start_year and summarize by mean and remove NA values

```{r}
all_awards_revised %>% 
    group_by(uni_state,start_year) %>% 
  summarize(mean_awardamt = mean(amt, na.rm= TRUE))
```

-   Sum Award Amount per University (all time)
    -   Method: group by uni_state, and then summarize by sum and remove NA values

```{r}
all_awards_revised %>% 
    group_by(uni_state) %>% 
  summarize(sum_awardamt = sum(amt, na.rm= TRUE))

```

-   Sum Amount per University per Year
    -   Method: group by uni_state and start_year, summarize by sum and remove NA values

```{r}
all_awards_revised %>% 
    group_by(uni_state,start_year) %>% 
  summarize(sum_awardamt = sum(amt, na.rm= TRUE))
```

-   Award Amount per Grant Period
    -   Method: Mutate a column of difference between start and end year, award amount on a yearly basis

```{r}
all_awards_revised <- all_awards_revised %>%
  mutate(grant_period = (end_year-start_year)+1)

all_awards_revised <- all_awards_revised %>% 
    mutate(average_annual_awd_amt = amt/grant_period)


```

-   Average Award Amount per Grant Period

    -   Method: group by uni_state, summarize by mean of average_annual_awd_amt and remove NA values

```{r}
all_awards_revised %>% 
    group_by(uni_state, average_annual_awd_amt) %>% 
  summarise(mean_average_annual_awd_amt= mean(average_annual_awd_amt))
```

## Awards Data Visualization

### Total Sum of Award Amount per University

```{r}
library(ggplot2)
all_awards_revised %>% 
    group_by(uni_state) %>% 
    summarize(sum_awardamt = sum(amt)) %>% 
  ggplot(mapping=aes(x=factor(uni_state, level=c('Louisiana', 'Idaho', 'Montana', 'Michigan', 'Minnesota', 'California')), y=sum_awardamt)) +
  geom_col(fill="blue") +
  labs(title= "Total Sum of Award Amount per University", x= "University", y= "Sum Award Amount")

```

### Average Annual Award Amount per University

```{r}
library(ggplot2)
all_awards_revised %>% 
    group_by(uni_state) %>% 
    summarize(average_annual_awd_amt) %>% 
  ggplot(mapping=aes(x=factor(uni_state, level=c('Louisiana', 'Idaho', 'Montana', 'Michigan', 'Minnesota', 'California')), y=average_annual_awd_amt)) +
  geom_col(fill="blue") +
  labs(title= "Average Annual Award Amount per University", x= "University", y= "Average Annual Award Amount")
  
```

### Experimenting with School Specific Award Data...

Taking a more microscopic view, we can look into the temporal awards data at the university-specific level.

```{r}
all_awards_revised_ca <- all_awards_revised %>% 
  filter(uni_state == "California")

library(ggplot2)
all_awards_revised_ca %>% 
    group_by(uni_state,start_year) %>% 
    summarize(average_annual_awd_amt) %>% 
  ggplot(mapping=aes(x=start_year, y=average_annual_awd_amt)) +
  geom_col(fill="blue") +
  labs(title= "Average Annual Award Amount per Year in California", x= "Start Year of Award", y= "Average Annual Award Amount")
```

### 

```{r}
all_awards_revised_mn <- all_awards_revised %>% 
  filter(uni_state == "Minnesota")

library(ggplot2)
all_awards_revised_mn %>% 
    group_by(uni_state,start_year) %>% 
    summarize(average_annual_awd_amt) %>% 
  ggplot(mapping=aes(x=start_year, y=average_annual_awd_amt)) +
  geom_col(fill="blue") +
  labs(title= "Average Annual Award Amount per Year in Minnesota", x= "Start Year of Award", y= "Average Annual Award Amount")
```

### Project Count by University

Looking at the total amount of projects undertaken by the different universities gives us a clearer understanding as to why some universities may be receiving more funding than others.

```{r}
all_awards_revised %>%
  group_by(uni_state) %>%
  count() %>%
  arrange(-n)

ggplot(all_awards_revised, aes(x=factor(uni_state, level=c('Louisiana', 'Michigan', 'Montana', 'Minnesota', 'Idaho', 'California'))), fill = uni_state) + 
  geom_bar(fill="blue") +
  theme(axis.text.x = element_text(angle=70, vjust=0.5)) +
  scale_fill_viridis_d(option = "C") +
  labs(title = "Total Project Count by University",
       x = "University", y = "Project Count", fill = "University") +
  theme_classic()
```

### Awards From a Temporal View

Grouping projects into 5 year time periods, we can depict the distribution of the amount of projects taking place at the different universities over time. In this graph, time periods begin in 2001 and end in 2020, licenses before 2001 are group as "Older" as they were deemed inconsistent in nature.

```{r}
all_awards_revised <- all_awards_revised %>%
  filter(start_year < 2021) %>%
  mutate(year_range = case_when(start_year > 2015 ~ "2016-2020", start_year > 2010 ~ "2011-2015", start_year > 2005 ~ "2006-2010", start_year > 2000 ~ "2001-2005", TRUE ~ "Older"))


ggplot(all_awards_revised, aes(x = factor(year_range, level=c('Older', '1996-2000', '2001-2005', '2006-2010', '2011-2015', '2016-2020')), fill = uni_state)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle=70, vjust=0.5)) +
  scale_fill_viridis_d(option = "C") +
  labs(title = "Project Count per University Throughout the Years",
       x = "Year Range", y = "Project Count", fill = "University") +
  theme_classic()
```

## More Awards Data Manipulation

-   Within UC Davis, how does funding vary across department? Is the data clean?
    -   UC Davis Exploration: Looking at mean award amounts across all the different departments at UC Davis it becomes apparent that this data is not very clean. There are repetitions in programs such as: "International Ag Program" and "International Ag Programs". Other departments such as "Phoenix" or "Metro Cluster" that are not clearly understood where these categories could fall into. As we do not have a clear understanding as to what these departments are/mean and how they should be categorized we will most likely avoid grouping by departments and cleaning this data.

```{r, eval = F}
all_awards_revised %>% 
  filter(uni_state == "California") %>% 
  group_by(Dept) %>% 
  summarize(mean_awardamt = mean(amt))
```

# Inventors Data

## Describe the inventors data

## Inventors data frame column names and descriptions:

-   uni_state: "University State"
-   inventor_last: "Inventor Last Name"
-   inventor_first: "Inventor First Name"
-   inventor_first_1: "Inventor First Name Initial"
-   inventor_ID: "Inventor ID"

```{r}
colnames(inventors)
```

## Inventors Data Summary

-   Inventors per state

    -   Method: look into inventors data frame, group by university state and summarize through summing the inventor IDs per university.

```{r}
inventors %>% 
  group_by(uni_state) %>% 
  summarize(sum_inventor_state = sum(inventor_ID))
```

-   Number of *unique* inventors in our inventors data frame
    -   Method: In order to double check that there are/are not duplicates of inventors in our data frame we will go ahead and take the number of distinct inventors through taking the number of distinct IDs and comparing that to the number of distinct inventor first name, last name, and first initial.

        -   Discovery: There are duplicate inventors in the data frame! These are inventors who are registered inventors in multiple states, these include: William D Stegmeir (Michigan, Kansas, Oregon, Minnesota) and Chaofu Lu (Montana and Washington)

```{r}
#unique(inventors$inventor_ID)
n_distinct(inventors$inventor_ID)
n_distinct(inventors$inventor_last,inventors$inventor_first, inventors$inventor_first_1)

#duplicated(select(inventors,inventor_last,inventor_first,inventor_first_1))
##why are these numbers different, is inventor_ID not unique to each individual inventor or just a general count of how many inventors we have? How can I double check my work
#Duplicates of William D Stegmeir (Michigan, Kansas, Oregon, Minnesota) and Chaofu Lu (Montana and Washington)

##JOIN--> visualization and summary (finish in next couple of days), aiming to join awards data and inventor data.
  #-
```

-   Comparing this number of *unique* inventors in our inventors data frame to our *unique* inventors (PIs) in our awards data frame.
    -   There is a large discrepancy between the number of *unique* inventors between the two data frames

        -   Inventor df: 247

        -   Awards df: 3197

```{r}
#unique(all_awards$PIFullName)
n_distinct((all_awards$PIFullName))

```

```{r}
#all_awards_revised %>% 
 # filter(breeder==T)

n_distinct(all_awards$inventor_ID)
```

## Questions to continue working on:

-   Of the award data that we have for breeder inventors (so keep using your filtered breeder == T data frame), what departments are the breeders coming from? How many breeders are in each department?
-   Again considering only the breeder award data, how much money has each university's breeders gotten each year? (Hint: again, group_by uni_state and year again with this data frame)
-   Who are the top funders of awards to breeders? (i.e. who is giving out the most money?

# Joining

## Renaming Column Names for Clarity:

-   inventor_last --\> "inventor_lastname"
-   inventor_first_1 --\> "inventor_first"
-   breeder --\> "inventorlist_check"
-   inventor_first --\> "inventor_firstname"

** Liza started editing here ** 
```{r}
colnames(inventors)
colnames(inventors)[2] = "inventor_lastname"
colnames(inventors)[3] = "inventor_firstname"
colnames(inventors)[4] = "inventor_first_initial"

colnames(all_awards_revised)
colnames(all_awards_revised)[3] = "inventor_first_initial"
```

```{r}
#awards_inventors_joined <- left_join(inventors, all_awards_revised, by="inventor_firstname")

#how do I join by more than one field?

```

Join based on first initial to get the most flexible match, but not over-general (use uni_name)
```{r}
inventors_awards <- left_join(inventors, all_awards_revised,
                              by = c("uni_state", "inventor_lastname",
                                      "inventor_first_initial"))
# remove the ones we don't have award data for
inventors_awards <- filter(inventors_awards, !is.na(ProjectTitle))
```



```{r}
# See the flexibility we achieved
inventors_awards %>% 
  select(uni_state, inventor_lastname, inventor_first_initial, 
         inventor_firstname.x, inventor_firstname.y) %>% 
  unique() %>% 
  arrange(inventor_lastname)

# How many matches?
inventors_awards %>% 
  #filter(!is.na(Sponsor)) %>% 
  select(uni_state, inventor_lastname) %>% 
  unique() %>% 
  nrow()
# 53 matches

write.csv(inventors_awards, "data_clean/inventor_awards.csv", row.names = F)

```

